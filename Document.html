<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="Document.css">
    <title>Document</title>
</head>
<body>
    <div id="home_menu">
        <ul>
            <li><button onclick="handleHomePageClick()">Back</button></li>
            <li id="document_name">Document</li>
            <li><button onclick="handleSaveDocumentClick()">Save</button></li>
        </ul>
    </div>

    <div id="pages"></div>

    <div id="editing_menus">
        <div id="selected_menu">
            <!--Fill this div with items for the selected menu-->
        </div>
        <ul>
            <li><button onclick="handleBlockMenuClick()">Block</button></li>
            <li><button onclick="handleEditMenuClick()">Edit</button></li>
            <li><button onclick="handleDisplayMenuClick()">Display</button></li>
        </ul>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <!--<script src="DocumentClasses.js" type="text/javascript"></script>-->
    
    <script type="text/javascript">
        //Retrieve data from local storage and clear for future documents
        const FILE_ID = localStorage.getItem("fileId");
        let DOCUMENT = new Doc(localStorage.getItem("fileName"));
        localStorage.clear();

        //Hide selected menu
        //document.getElementById("selected_menu").style.visibility = 'hidden';
        document.getElementById("selected_menu").innerHTML = '';

        function loadBlock(block) {
            //words = block.GetWords();
            let HTMLText = `<div contenteditable="true" class="block">${block.GetText()}</div>`;

            return HTMLText;
        }

        //Load document text
        async function loadText(getRemote=true) {
            if(getRemote) {
                let fileId = JSON.parse(FILE_ID);

                let res = await gapi.client.drive.files.get({
                'fileId': fileId,
                'alt': 'media',
                }, {
                'responseType': 'arraybuffer',
                });

                DOCUMENT.FromJSON(JSON.parse(JSON.stringify(res)).result);
            }

            //Create pages/blocks based on DOCUMENT
            let pages = DOCUMENT.GetPages();
            let blocks;
            let HTMLText = '';
            for(let pageIndex=0; pageIndex < pages.length; pageIndex++) {
                HTMLText = '';
                blocks = pages[pageIndex].GetBlocks();
                for(blockIndex=0; blockIndex < blocks.length; blockIndex++) {
                    HTMLText += loadBlock(blocks[blockIndex]);
                }
                HTMLText = '<div class="page">' + HTMLText + '</div>';
                document.getElementById('pages').innerHTML += HTMLText;
            }
        }

        //Load document
        document.getElementById('document_name').innerText = DOCUMENT.GetName();
        loadText(true); //Must be async

        /*
        *Return to the home page
        */
        function handleHomePageClick() {
            //Change to home page
            window.location.reload();
        }

        function addPage() {
            let pageDiv = document.createElement("div");
            let menu = document.getElementById('pages');

            pageDiv.setAttribute("class", "page");

            menu.appendChild(pageDiv);
            DOCUMENT.AddPage();
        }

        /*
        *Save the document
        */
        function handleSaveDocumentClick(save=true) {
            //Load text into Doc class
            let pages = DOCUMENT.GetPages();
            let docBlocks = [];
            let blocks;
            let block;

            for(let pageIndex=0; pageIndex < pages.length; pageIndex++) {
                blocks = pages[pageIndex].GetBlocks();
                for(let blockIndex=0; blockIndex < blocks.length; blockIndex++) {
                    docBlocks.push(blocks[blockIndex]);
                }
            }
            DOCUMENT.Clear();

            pages = document.getElementsByClassName('page');

            for(let pageIndex = 0; pageIndex < pages.length; pageIndex++) {
                let curPage = new Page();
                blocks = pages.item(pageIndex).getElementsByClassName('block');

                for(let blockIndex = 0; blockIndex < blocks.length; blockIndex++) {
                    block = docBlocks[blockIndex];
                    block.SetText(blocks[blockIndex].innerText);
                    curPage.AddBlock(blocks.length, block);
                }

                DOCUMENT.AddPage(DOCUMENT.GetPageCount(), curPage);
            }

            if(save) {
                //Send Document class
                const url = 'https://www.googleapis.com/upload/drive/v3/files/' + JSON.parse(FILE_ID) + '?uploadType=media';
                fetch(url, {
                    'method': 'PATCH',
                    'headers': new Headers({
                        'Authorization': 'Bearer ' + gapi.auth.getToken().access_token,
                        'Content-type': 'text/plain'
                    }),
                    'body': `${DOCUMENT.ToJSON()}`
                }).then(alert('File saved.'));
            }
        }

        function handleAddBlockTemplateClick() {
            //Save new block to DOCUMENT
            //TODO: Check for unique names somewhere
            DOCUMENT.AddBlock(new Block('', document.getElementById("block_type").value, document.getElementById("block_priority").value, document.getElementById("block_alignment").value));

            //Reset and call handleBlockMenuClick()
            document.getElementById("selected_menu").innerHTML = '';
            handleBlockMenuClick();
        }

        function handleCreateBlockTemplateClick() {
            //Populate menu to create new block
            document.getElementById("selected_menu").innerHTML = `
            <div>
                <label>Please enter a block name: </label>
                <textarea id="block_type" style="height: 10px; width: 60px; resize: none;"></textarea>
            </div>
            <div>
                <label>Please select a text alignment for the block: </label>
                <select name="priority" id="block_priority">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>
            <div>
                <label>Please select a text alignment for the block: </label>
                <select name="alignment" id="block_alignment">
                    <option value="left">left</option>
                    <option value="center">center</option>
                    <option value="right">right</option>
                </select>
            </div>
            <div id="submit"><button id="submit_button" onclick="handleAddBlockTemplateClick()">Submit</button></div>`;
        }

        function handleCreateBlockClick(block) {
            //Append block to end of last page
            //TODO: Allow for blocks to be added anywhere
            console.log('In click Function!');
            let argJSON = block.getAttribute('data-arg1');
            argJSON = argJSON.replaceAll("'", '"');
            console.log(argJSON);
            console.log(JSON.parse(argJSON));
            console.log('Adding block');
            console.log(new Block().FromJSON(JSON.parse(argJSON)));
            block = new Block();
            block.FromJSON(JSON.parse(argJSON));
            //console.log(new Block().FromJSON(JSON.parse(block)));
            let HTMLText = loadBlock(block);
            let pages = document.getElementsByClassName('page'); //Load pages

            console.log(pages);
            if(pages.length == 0) {
                addPage();
                pages = document.getElementsByClassName('page'); //Load pages
            }

            console.log('Adding to page and document');
            pages[pages.length - 1].innerHTML += HTMLText; //Load block into end of last page
            DOCUMENT.AddBlockToPage(block);
            console.log(DOCUMENT);
        }

        function handleCleanClick() {
            DOCUMENT.Clean();

            document.getElementById("pages").innerHTML = '';
            loadText();

            //Close Display menu and reopen for reload of blocks
            handleDisplayMenuClick();
            handleDisplayMenuClick();
        }

        function handleEditMenuClick() {
            /*let target = document.getElementById('pages');

            if (window.getComputedStyle(target).display === 'none') {
                //TODO: Clear div
                document.getElementById("selected_menu").style.visibility = 'hidden';

                return slideDown(target);
            }
            else {
                //TODO: Populate div
                document.getElementById("selected_menu").style.visibility = 'visible';

                return slideUp(target);
            }*/
        }

        function handleBlockMenuClick() {
            let menu = document.getElementById("selected_menu");

            if(menu.innerHTML != '') {
                //Clear div
                menu.innerHTML = '';
                menu.style.visibility = 'hidden';
            }
            else {
                //Populate div
                handleSaveDocumentClick(false); //Syncs DOCUMENT to actual data

                menu.innerHTML = `
                <div class="grid-container">
                    <div class="grid-item"><button id="create_block_template" onclick="handleCreateBlockTemplateClick()">Create New Block Template</button></div>`;

                let blocks = DOCUMENT.GetBlocks();
                for(blockIndex=0; blockIndex < blocks.length; blockIndex++) {
                    let blockDiv = document.createElement("div");
                    blockDiv.setAttribute("class", "grid-item");
                    blockDiv.innerHTML=`<button data-arg1="${JSON.stringify(blocks[blockIndex].ToJSON()).replaceAll('"', "'")}" onClick="handleCreateBlockClick(this)">Create ${blocks[blockIndex].GetType()} Block</button>`;

                    //let passBlock = blocks[blockIndex];
                    //handleCreateBlockClick(passBlock);
                    /*blockDiv.firstChild.addEventListener('click', function(this) {
                        console.log('In click Function!');
                        let argJSON = this.getAttribute('data-arg1');
                        console.log(argJSON);
                        handleCreateBlockClick(new Block().FromJSON(argJSON));
                    });*/

                    console.log('Adding child');
                    menu.appendChild(blockDiv);
                    //menu.innerHTML += `<div id="${blocks[blockIndex].GetType()}" class="grid-item"><button onclick="handleCreateBlockClick(${blocks[blockIndex].GetType()})">Create ${blocks[blockIndex].GetType()} Block</button></div>`
                }

                //menu.innerHTML += '</div>';
                menu.style.visibility = 'visible';
            }
        }

        function handleDisplayMenuClick() {
            let menu = document.getElementById("selected_menu");

            if(menu.innerHTML != '') {
                //Clear div
                menu.innerHTML = '';
                menu.style.visibility = 'hidden';
            }
            else {
                //Populate div
                handleSaveDocumentClick(false); //Syncs DOCUMENT to actual data
                let wordCount = DOCUMENT.WordCount();
                menu.innerHTML = `
                <div id="word_count">Word Count: ${wordCount[0]}</div>
                <div id="average_word_count">Average Word Length: ${wordCount[1]}</div>
                <div id="clean"><button id="clean_button" onclick="handleCleanClick()">Clean Document</button></div>
                <div>Dropdown to select blocks of a certain type or all blocks</div>
                <div>List of blocks</div>
                `;
                menu.style.visibility = 'visible';
            }
        }
    </script>
</body>
</html>
