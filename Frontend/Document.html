<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="Document.css">
    <title>Document</title>
</head>
<body>
    <div id="home_menu">
        <ul>
            <li><button onclick="handleHomePageClick()">Back</button></li>
            <li id="document_name">Document</li>
            <li><button onclick="handleSaveDocumentClick()">Save</button></li>
        </ul>
    </div>

    <div id="pages">
        <textarea id="block1"></textarea>
    </div>

    <div id="block_menu">
        <ul>
            <li><button>Block</button></li>
            <li><button>Edit</button></li>
            <li><button>Display</button></li>
        </ul>
    </div>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <script type="text/javascript">
        //Retrieve data from local storage and reet for future documents
        const FILE_ID = localStorage.getItem("fileId");
        const ACCESS_TOKEN = JSON.parse(localStorage.getItem("accessToken"));
        alert(alert(JSON.stringify(ACCESS_TOKEN, null, 4)));
        document.getElementById('document_name').innerText = localStorage.getItem("fileName");
        localStorage.clear();

        //API variables
        const CLIENT_ID = '576519804905-crn5en1klti0nue1qq146fuj4keo9vvs.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyB_cVGez_ASJg33xq7fqO35_tRf-NiXC1M';
        let gapi = window.gapi;

        // Discovery doc URL for APIs used by the quickstart
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

        // Authorization scopes required by the API; multiple scopes can be included, separated by spaces.
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        /**
         * Callback after api.js is loaded.
         */
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        /**
         * Callback after the API client is loaded. Loads the
         * discovery doc to initialize the API.
         */
        async function initializeGapiClient() {
            await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
            });
        }

        /**
         * Callback after Google Identity Services are loaded.
         */
        function gisLoaded() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
        }

        //Initialize gapi to retrieve data
        //gapiLoaded();
        //gisLoaded();

        gapi.load('client', function () {
                gapi.client.load('drive', 'v3', function () {
                    var file = gapi.client.drive.files.get({ 'fileId': FILE_ID });
                    file.execute(function (response) {
                        //Write you code with response variable
                        document.getElementById("block1").value = JSON.parse(JSON.stringify(response, null, 4)).body;
                    });

                });
            });

        /*let response = gapi.client.request({
            'fileId': FILE_ID,
            'alt': 'media',
            }, {
            'responseType': 'arraybuffer',
        });*/

        //Load document text
        /*const response = gapi.client.drive.files.get({
            'fileId': fileId,
            'alt': 'media',
        }, {
            'responseType': 'arraybuffer',
        });
        document.getElementById("block1").value = JSON.parse(JSON.stringify(response, null, 4)).body;
        */

        /*
        *Return to the home page
        */
        function handleHomePageClick() {
            //Change to home page
            window.location.href = "../index.html";
        }

        /*
        *Save the document
        */
        function handleSaveDocumentClick() {
            const url = 'https://www.googleapis.com/upload/drive/v3/files/' + FILE_ID + '?uploadType=media';
            fetch(url, {
                'method': 'PATCH',
                'headers': new Headers({
                    'Authorization': 'Bearer ' + ACCESS_TOKEN, //TODO: Code works, but access token doesn't?
                    'Content-type': 'text/plain'
                }),
                'body': `${document.getElementById('block1').value}`
            })
                .then(result => result.json())
                .then(value => {
                    console.log('Updated. Result:\n' + JSON.stringify(value, null, 2));
                })
                .catch(err => console.error(err))
        }
    </script>

    <!--<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>-->
</body>
</html>
