<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="Document.css">
    <title>Document</title>
</head>
<body>
    <div id="home_menu">
        <ul>
            <li><button onclick="handleHomePageClick()">Back</button></li>
            <li id="document_name">Document</li>
            <li><button onclick="handleSaveDocumentClick()">Save</button></li>
        </ul>
    </div>

    <div id="pages">
        <textarea id="block1"></textarea>
    </div>

    <div id="block_menu">
        <ul>
            <li><button>Block</button></li>
            <li><button>Edit</button></li>
            <li><button>Display</button></li>
        </ul>
    </div>

    <script type="text/javascript">
        //Retrieve data from local storage and reet for future documents
        const FILE_ID = localStorage.getItem("fileId");
        document.getElementById('document_name').innerText = localStorage.getItem("fileName");
        localStorage.clear();

        //Load document text
        async function loadText() {
            let fileId = JSON.parse(FILE_ID);

            /*request = gapi.client.drive.files.get({
            'fileId': fileId
            });*/

            let res = await gapi.client.drive.files.get({
            'fileId': fileId,
            'alt': 'media',
            }, {
            'responseType': 'arraybuffer',
            });

            document.getElementById("block1").value = JSON.parse(JSON.stringify(res, null, 4)).body;
        }
        loadText(); //Must be async

        /*
        *Return to the home page
        */
        function handleHomePageClick() {
            //Change to home page
            window.location.reload();
        }

        /*
        *Save the document
        */
        function handleSaveDocumentClick() {
            const url = 'https://www.googleapis.com/upload/drive/v3/files/' + JSON.parse(FILE_ID) + '?uploadType=media';
            fetch(url, {
                'method': 'PATCH',
                'headers': new Headers({
                    'Authorization': 'Bearer ' + gapi.auth.getToken().access_token,
                    'Content-type': 'text/plain'
                }),
                'body': `${document.getElementById('block1').value}`
            })
                .then(result => result.json())
                .then(value => {
                    console.log('Updated. Result:\n' + JSON.stringify(value, null, 2));
                })
        }
    </script>
</body>
</html>
